/*
 * jQuery viewbook plugin
 * Copyright (c) 2010 W. Grauvogel
 *
 * Version : 1.0.0
 *
 * Originally based on the work of:
 *	1) Charles Mangin (http://clickheredammit.com/pageflip/)
 */
(function(e){e.fn.viewbook=function(f){var g=e.extend({},e.fn.viewbook.defaults,f);return e(this).each(function(){var m,h,l,n,j,k;if(typeof f=="string"){if(e(this).data("viewbook")){m=f.toLowerCase();l=e.fn.viewbook.interfaces[e(this).data("id")];if(m=="next"){l.next()}else{if(m=="prev"){l.prev()}}}}else{if(typeof f=="number"){if(e(this).data("viewbook")){k=f;l=e.fn.viewbook.interfaces[e(this).data("id")];if(k%2!=0){k-=1}l.gotoPage(k)}}else{h=e.extend(true,{},g);n=e.fn.viewbook.interfaces.length;for(j=0;j<n;j++){if(typeof e.fn.viewbook.interfaces[j]=="undefined"){n=j;break}}l=new b(e(this),h,n);e.fn.viewbook.interfaces[n]=l;l.resetPages();l.updateCtrls()}}})};function b(f,D,K){var q,E,B,T,W,V,j=new Array(),h=new Array(),ad=new Array(),S=new Array(),I,ai,ag,ae,aa,Z,u,C,r,ah,J,A,s,O,R,x,M,L,p,H,F,Q,o,n,l,G,v,t,ac,P,w,af,g,Y,m,X,k,z,U,y,ab,N;V=false;q=this;q.options=D;q.id=K;q.hash="";E=q.options;B=f.addClass("viewbook");B.find(".vb-load").children().each(function(aj){j[aj]=e(this);if(e(this).attr("rel")){ad[aj]=e(this).attr("rel")}else{ad[aj]=""}h[aj]=e(this).attr("title");S[aj]=e(this).attr("class")});if((j.length%2)!=0){j[j.length]='<div class="vb-page-blank"></div>';ad[j.length]="";h[j.length]="";S[j.length]=""}B.data("viewbook",true);B.data("id",K);B.data("total",j.length);B.prepend('<div class="vb-pN vb-page"><div class="vb-p-wrap"></div></div><div class="vb-p1 vb-page"><div class="vb-p-wrap"></div></div><div class="vb-p4 vb-page"><div class="vb-p-wrap"></div></div><div class="vb-p2 vb-page"><div class="vb-p-wrap"></div></div><div class="vb-p3 vb-page"><div class="vb-p-wrap"></div></div><div class="vb-p0 vb-page"><div class="vb-p-wrap"></div></div><div class="vb-overlay vb-overlay-prev vb-prev" title="Previous Page"></div><div class="vb-overlay vb-overlay-next vb-next" title="Next Page"></div>');I=B.find(".vb-pN");ai=B.find(".vb-p0");ag=B.find(".vb-p1");ae=B.find(".vb-p2");aa=B.find(".vb-p3");Z=B.find(".vb-p4");u=B.find(".vb-pN .vb-p-wrap");C=B.find(".vb-p0 .vb-p-wrap");r=B.find(".vb-p1 .vb-p-wrap");ah=B.find(".vb-p2 .vb-p-wrap");J=B.find(".vb-p3 .vb-p-wrap");A=B.find(".vb-p4 .vb-p-wrap");s=B.find(".vb-p-wrap");O=R=null;M=B.find(".vb-overlay-next");L=B.find(".vb-overlay-prev");x=B.find(".vb-overlay");if(E.shadows){O=e('<div class="vb-shadow-f"></div>').appendTo(aa);R=e('<div class="vb-shadow-b"></div>').appendTo(ai)}if(!E.width){E.width=B.width()}if(!E.height){E.height=B.height()}B.width(E.width);B.height(E.height);E.pWidth=E.width/2;E.pWidthN="-"+(E.width/2)+"px";E.pWidthH=E.width/4;E.pHeight=E.height;E.pTotal=j.length;E.speedH=E.speed/2;if(isNaN(E.startingPage)||E.startingPage>E.pTotal||E.startingPage<=0){E.curr=0}else{if((E.startingPage%2)!=0){E.startingPage--}E.curr=E.startingPage}if(E.name){document.title=E.name}else{E.name=document.title}if(E.shadows){E.shadowTopFwdWidth="-"+E.shadowTopFwdWidth+"px";E.shadowTopBackWidth="-"+E.shadowTopBackWidth+"px"}if(E.menu){ac=e(E.menu).addClass("vb-menu");if(E.pageSelector){w=e('<div class="vb-selector vb-selector-page"><span class="vb-current">'+(E.curr+1)+"-"+(E.curr+2)+"</span></div>").appendTo(ac);af=e("<ul></ul>").appendTo(w).empty().css("height","auto");for(W=0;W<E.pTotal;W+=2){Y=e('<li><a href="#/page/'+(W+1)+'" id="selector-page-'+W+'"><span class="vb-text">'+h[W]+'</span><span class="vb-num">'+(W+1)+" - "+(W+2)+"</span></a></li>").appendTo(af);m=Y.find("a");if(!E.hash){m.click(function(){X=parseInt(e(this).attr("id").replace("selector-page-",""));q.gotoPage(X);return false})}}g=af.height();af.css({height:0,"padding-bottom":0});w.unbind("hover").hover(function(){af.stop().animate({height:g,paddingBottom:10},500)},function(){af.stop().animate({height:0,paddingBottom:0},500)})}if(E.chapterSelector){P=ad[E.curr];if(P==""){P=ad[E.curr+1]}k=e('<div class="vb-selector vb-selector-chapter"><span class="vb-current">'+P+"</span></div>").appendTo(ac);z=e("<ul></ul>").appendTo(k).empty().css("height","auto");for(W=0;W<E.pTotal;W+=1){if(ad[W]!=""){y=e('<li><a href="#/page/'+(W+1)+'" id="selector-page-'+W+'"><span class="vb-text">'+ad[W]+"</span></a></li>").appendTo(z);ab=y.find("a");if(!E.hash){ab.click(function(){N=parseInt(e(this).attr("id").replace("selector-page-",""));q.gotoPage(N);return false})}}}U=z.height();z.css({height:0,"padding-bottom":0});k.unbind("hover").hover(function(){z.stop().animate({height:U,paddingBottom:10},500)},function(){z.stop().animate({height:0,paddingBottom:0},500)})}}e.extend(q,{next:function(){if(E.curr+2<E.pTotal&&!V){V=true;E.curr+=2;E.before.call(q);q.updatePager();q.updateCtrls();c(E.curr+1,E);ae.animate({width:0},E.speedH,E.easeIn);if(E.shadows){if(e.support.opacity){O.animate({opacity:1},E.speedH,E.easeIn).animate({opacity:0},E.speedH,E.easeOut)}else{O.animate({right:E.shadowTopFwdWidth},E.speed,E.easeIn)}}aa.animate({left:E.pWidthH,width:E.pWidthH,paddingLeft:E.shadowBtmWidth},E.speedH,E.easeIn).animate({left:0,width:E.pWidth,paddingLeft:0},E.speedH);J.animate({left:E.shadowBtmWidth},E.speedH,E.easeIn).animate({left:0},E.speedH,E.easeOut,function(){q.resetPages();q.updatePager();q.updateCtrls();E.after.call(q);V=false})}},prev:function(){if(E.curr-2>=0&&!V){V=true;E.curr-=2;E.before.call(q);q.updatePager();q.updateCtrls();c(E.curr+1,E);I.show();ag.animate({left:E.pWidth,width:0},E.speed,E.easing);r.animate({left:E.pWidthN},E.speed,E.easing);if(E.shadows){if(e.support.opacity){R.animate({opacity:1},E.speedH,E.easeIn).animate({opacity:0},E.speedH,E.easeOut)}else{R.animate({left:E.shadowTopBackWidth},E.speed,E.easeIn)}}ai.animate({left:E.pWidthH,width:E.pWidthH},E.speedH,E.easeIn).animate({left:E.pWidth,width:E.pWidth},E.speedH,E.easeOut);C.animate({right:E.shadowBtmWidth},E.speedH,E.easeIn).animate({right:0},E.speedH,E.easeOut,function(){q.resetPages();q.updatePager();q.updateCtrls();E.after.call(q);V=false})}},gotoPage:function(i){if(i>E.curr&&i<E.pTotal&&i>=0&&!V){V=true;E.curr=i;E.before.call(q);q.updatePager();q.updateCtrls();J.html(j[E.curr]);A.html(j[E.curr+1]);if(E.pageNumbers){J.append('<div class="vb-counter">'+(E.curr+1)+"</div>");A.append('<div class="vb-counter">'+(E.curr+2)+"</div>")}ae.animate({width:0},E.speedH,E.easeIn);if(E.shadows){if(e.support.opacity){O.animate({opacity:1},E.speedH,E.easeIn).animate({opacity:0},E.speedH,E.easeOut)}else{O.animate({right:E.shadowTopFwdWidth},E.speed,E.easeIn)}}aa.animate({left:E.pWidthH,width:E.pWidthH,paddingLeft:E.shadowBtmWidth},E.speedH,E.easeIn).animate({left:0,width:E.pWidth,paddingLeft:0},E.speedH);J.animate({left:E.shadowBtmWidth},E.speedH,E.easeIn).animate({left:0},E.speedH,E.easeOut,function(){q.resetPages();q.updatePager();q.updateCtrls();E.after.call(q);V=false})}else{if(i<E.curr&&i<E.pTotal&&i>=0&&!V){V=true;E.curr=i;E.before.call(q);q.updatePager();q.updateCtrls();u.html(j[E.curr]);C.html(j[E.curr+1]);if(E.pageNumbers){u.append('<div class="vb-counter">'+(E.curr+1)+"</div>");C.append('<div class="vb-counter">'+(E.curr+2)+"</div>")}I.show();ag.animate({left:E.pWidth,width:0},E.speed,E.easing);r.animate({left:E.pWidthN},E.speed,E.easing);if(E.shadows){if(e.support.opacity){R.animate({opacity:1},E.speedH,E.easeIn).animate({opacity:0},E.speedH,E.easeOut)}else{R.animate({left:E.shadowTopBackWidth},E.speed,E.easeIn)}}ai.animate({left:E.pWidthH,width:E.pWidthH},E.speedH,E.easeIn).animate({left:E.pWidth,width:E.pWidth},E.speedH,E.easeOut);C.animate({right:E.shadowBtmWidth},E.speedH,E.easeIn).animate({right:0},E.speedH,E.easeOut,function(){q.resetPages();q.updatePager();q.updateCtrls();E.after.call(q);V=false})}}},resetPages:function(){s.css({width:E.pWidth-20,height:E.pHeight-20});r.html(j[E.curr]).css({left:0,opacity:1});ag.css({left:0,width:E.pWidth,height:E.pHeight});ah.html(j[E.curr+1]);ae.css({left:E.pWidth,width:E.pWidth,opacity:1,height:E.pHeight});u.html(j[E.curr-2]);I.css({left:0,width:E.pWidth,height:E.pHeight}).hide();C.html(j[E.curr-1]);ai.css({left:0,width:0,height:E.pHeight});J.html(j[E.curr+2]);aa.css({left:E.pWidth*2,width:0,height:E.pHeight});A.html(j[E.curr+3]);Z.css({left:E.pWidth,width:E.pWidth,height:E.pHeight});if(E.shadows){O.css({right:0,width:E.pWidth,height:E.pHeight});R.css({left:0,width:E.pWidth,height:E.pHeight})}if(E.pageNumbers){r.append('<div class="vb-counter">'+(E.curr+1)+"</div>");ah.append('<div class="vb-counter">'+(E.curr+2)+"</div>");u.append('<div class="vb-counter">'+(E.curr-1)+"</div>");C.append('<div class="vb-counter">'+(E.curr)+"</div>");J.append('<div class="vb-counter">'+(E.curr+3)+"</div>");A.append('<div class="vb-counter">'+(E.curr+4)+"</div>")}},updateCtrls:function(){if(E.overlays||E.tabs||E.arrows){if(E.curr<E.pTotal-2){v.fadeIn("fast").css("cursor",E.cursor)}else{v.fadeOut("fast").css("cursor","default")}if(E.curr>=2&&E.curr!=0){t.fadeIn("fast").css("cursor",E.cursor)}else{t.fadeOut("fast").css("cursor","default")}}},updatePager:function(){if(E.pageSelector){e(E.menu+" .vb-selector-page .vb-current").text((E.curr+1)+" - "+(E.curr+2))}if(E.chapterSelector&&ad[E.curr]!=""){e(E.menu+" .vb-selector-chapter .vb-current").text(ad[E.curr])}},setupHash:function(){T=d();if(!isNaN(T)&&T<=E.pTotal-1&&T>=0&&T!=""){if((T%2)!=0){T--}E.curr=T}else{c(E.curr+1,E)}q.hash=T},pollHash:function(){T=d();if(!isNaN(T)&&T<=E.pTotal-1&&T>=0){if(T!=E.curr&&T.toString()!=q.hash){if((T%2)!=0){T--}document.title=E.name+" - Page "+(T+1);if(!V){q.gotoPage(T);q.hash=T}}}}});if(E.next){l=e(E.next);l.click(function(i){i.preventDefault();q.next()})}if(E.prev){G=e(E.prev);G.click(function(i){i.preventDefault();q.prev()})}if(!E.overlays){x.remove()}else{if(e.browser.msie){x.css({background:"#fff",filter:"progid:DXImageTransform.Microsoft.Alpha(opacity=0) !important"})}}if(E.tabs){B.append('<div class="vb-tab vb-tab-prev vb-prev" title="Previous Page">Previous</div>');B.append('<div class="vb-tab vb-tab-next vb-next" title="Next Page">Next</div>');H=B.find(".vb-tab-next");F=B.find(".vb-tab-prev");p=B.find(".vb-tab");if(E.tabWidth){p.width(E.tabWidth)}if(E.tabHeight){p.height(E.tabHeight)}p.css({top:"-"+H.outerHeight()+"px"});B.css({marginTop:H.outerHeight()})}else{B.css({marginTop:0})}if(E.arrows){B.append('<div class="vb-arrow vb-arrow-prev vb-prev" title="Previous Page"><div>Previous</div></div>');B.append('<div class="vb-arrow vb-arrow-next vb-next" title="Next Page"><div>Next</div></div>');o=B.find(".vb-arrow-next");n=B.find(".vb-arrow-prev");Q=B.find(".vb-arrow")}v=B.find(".vb-next");t=B.find(".vb-prev");v.click(function(i){i.preventDefault();q.next()});t.click(function(i){i.preventDefault();q.prev()});if(E.arrows){if(e.support.opacity){v.hover(function(){o.find("div").stop().fadeTo("fast",1)},function(){o.find("div").stop().fadeTo("fast",0)});t.hover(function(){n.find("div").stop().fadeTo("fast",1)},function(){n.find("div").stop().fadeTo("fast",0)})}else{v.hover(function(){o.find("div").show()},function(){o.find("div").hide()});t.hover(function(){n.find("div").show()},function(){n.find("div").hide()})}}if(E.keyboard){e(document).keyup(function(i){if(i.keyCode==37){q.prev()}else{if(i.keyCode==39){q.next()}}})}if(E.hash){q.setupHash();clearInterval();setInterval(function(){q.pollHash()},250)}q.gotoPage(E.curr)}function d(){var f=window.location.hash.split("/");if(f.length>1){return parseInt(f[2])-1}else{return""}}function a(f){f=f||0;var g=window.location.hash.split("/");if(g.length>0){return g[f]}else{return""}}function c(g,f){if(f.hash){window.location.hash="/page/"+g}}e.fn.viewbook.interfaces=[];e.fn.viewbook.defaults={name:null,width:600,height:400,speed:1000,startingPage:0,easing:"easeInOutQuad",easeIn:"easeInQuad",easeOut:"easeOutQuad",overlays:true,tabs:true,tabWidth:60,tabHeight:20,arrows:false,cursor:"pointer",next:null,prev:null,hash:false,keyboard:true,menu:null,pageSelector:false,chapterSelector:false,pageNumbers:true,shadows:true,shadowTopFwdWidth:166,shadowTopBackWidth:166,shadowBtmWidth:50,before:function(){},after:function(){}}})(jQuery);