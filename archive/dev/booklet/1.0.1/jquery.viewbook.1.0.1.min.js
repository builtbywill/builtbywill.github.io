/*
 * jQuery viewbook plugin
 * Copyright (c) 2010 W. Grauvogel
 *
 * Version : 1.0.1
 *
 * Originally based on the work of:
 *	1) Charles Mangin (http://clickheredammit.com/pageflip/)
 */
(function(e){e.fn.viewbook=function(f){var g=e.extend({},e.fn.viewbook.defaults,f);return e(this).each(function(){var m,h,l,n,j,k;if(typeof f=="string"){if(e(this).data("viewbook")){m=f.toLowerCase();l=e.fn.viewbook.interfaces[e(this).data("id")];if(m=="next"){l.next()}else{if(m=="prev"){l.prev()}}}}else{if(typeof f=="number"){if(e(this).data("viewbook")){k=f;l=e.fn.viewbook.interfaces[e(this).data("id")];if(k%2!=0){k-=1}l.gotoPage(k)}}else{h=e.extend(true,{},g);n=e.fn.viewbook.interfaces.length;for(j=0;j<n;j++){if(typeof e.fn.viewbook.interfaces[j]=="undefined"){n=j;break}}l=new b(e(this),h,n);e.fn.viewbook.interfaces[n]=l;l.resetPages();l.updateCtrls()}}})};function b(f,H,Q){var u,I,F,aa,ae,ad,Z,ac,m=new Array(),l=new Array(),al=new Array(),Y=new Array(),h=new Array(),J=new Array(),O=new Array(),k=new Array(),N,aq,ao,am,ai,ah,y,G,v,ap,P,E,w,U,X,B,S,R,t,M,K,W,s,r,o,L,z,x,ak,V,A,an,g,ag,q,af,n,D,ab,C,aj,T;ac=false;u=this;u.options=H;u.id=Q;u.hash="";I=u.options;F=f.addClass("viewbook");F.find(".vb-load").children().each(function(j){m[j]=e(this);if(e(this).attr("rel")){al[j]=e(this).attr("rel")}else{al[j]=""}l[j]=e(this).attr("title");Y[j]=e(this).attr("class")});if((m.length%2)!=0){m[m.length]='<div class="vb-page-blank"></div>';al[m.length]="";l[m.length]="";Y[m.length]=""}F.data("viewbook",true);F.data("id",Q);F.data("total",m.length);F.prepend('<div class="vb-pN vb-page"><div class="vb-p-wrap"></div></div><div class="vb-p1 vb-page"><div class="vb-p-wrap"></div></div><div class="vb-p4 vb-page"><div class="vb-p-wrap"></div></div><div class="vb-p2 vb-page"><div class="vb-p-wrap"></div></div><div class="vb-p3 vb-page"><div class="vb-p-wrap"></div></div><div class="vb-p0 vb-page"><div class="vb-p-wrap"></div></div><div class="vb-overlay vb-overlay-prev vb-prev" title="Previous Page"></div><div class="vb-overlay vb-overlay-next vb-next" title="Next Page"></div>');N=F.find(".vb-pN");aq=F.find(".vb-p0");ao=F.find(".vb-p1");am=F.find(".vb-p2");ai=F.find(".vb-p3");ah=F.find(".vb-p4");y=F.find(".vb-pN .vb-p-wrap");G=F.find(".vb-p0 .vb-p-wrap");v=F.find(".vb-p1 .vb-p-wrap");ap=F.find(".vb-p2 .vb-p-wrap");P=F.find(".vb-p3 .vb-p-wrap");E=F.find(".vb-p4 .vb-p-wrap");w=F.find(".vb-p-wrap");U=X=null;S=F.find(".vb-overlay-next");R=F.find(".vb-overlay-prev");B=F.find(".vb-overlay");if(I.shadows){U=e('<div class="vb-shadow-f"></div>').appendTo(ai);X=e('<div class="vb-shadow-b"></div>').appendTo(aq)}if(!I.width){I.width=F.width()}if(!I.height){I.height=F.height()}F.width(I.width);F.height(I.height);I.pWidth=I.width/2;I.pWidthN="-"+(I.width/2)+"px";I.pWidthH=I.width/4;I.pHeight=I.height;I.pTotal=m.length;I.speedH=I.speed/2;if(I.direction=="RTL"){ad=0;for(ae=I.pTotal-1;ae>=0;ae--){h[ad]=m[ae];O[ad]=al[ae];J[ad]=l[ae];k[ad]=Y[ae];ad++}m=h;al=O;l=J;Y=k}if(I.direction=="LTR"){I.curr=0}else{if(I.direction=="RTL"){I.curr=I.pTotal-2}}if(!isNaN(I.startingPage)&&I.startingPage<=I.pTotal&&I.startingPage>0){if((I.startingPage%2)!=0){I.startingPage--}I.curr=I.startingPage}if(I.name){document.title=I.name}else{I.name=document.title}if(I.shadows){I.shadowTopFwdWidth="-"+I.shadowTopFwdWidth+"px";I.shadowTopBackWidth="-"+I.shadowTopBackWidth+"px"}if(I.menu){ak=e(I.menu).addClass("vb-menu");if(I.pageSelector){A=e('<div class="vb-selector vb-selector-page"><span class="vb-current">'+(I.curr+1)+"-"+(I.curr+2)+"</span></div>").appendTo(ak);an=e("<ul></ul>").appendTo(A).empty().css("height","auto");for(ae=0;ae<I.pTotal;ae+=2){ag=e('<li><a href="#/page/'+(ae+1)+'" id="selector-page-'+ae+'"><span class="vb-text">'+l[ae]+'</span><span class="vb-num">'+(ae+1)+" - "+(ae+2)+"</span></a></li>").appendTo(an);q=ag.find("a");if(!I.hash){q.click(function(){af=parseInt(e(this).attr("id").replace("selector-page-",""));u.gotoPage(af);return false})}}g=an.height();an.css({height:0,"padding-bottom":0});A.unbind("hover").hover(function(){an.stop().animate({height:g,paddingBottom:10},500)},function(){an.stop().animate({height:0,paddingBottom:0},500)})}if(I.chapterSelector){V=al[I.curr];if(V==""){V=al[I.curr+1]}n=e('<div class="vb-selector vb-selector-chapter"><span class="vb-current">'+V+"</span></div>").appendTo(ak);D=e("<ul></ul>").appendTo(n).empty().css("height","auto");for(ae=0;ae<I.pTotal;ae+=1){if(al[ae]!=""){C=e('<li><a href="#/page/'+(ae+1)+'" id="selector-page-'+ae+'"><span class="vb-text">'+al[ae]+"</span></a></li>").appendTo(D);aj=C.find("a");if(!I.hash){aj.click(function(){T=parseInt(e(this).attr("id").replace("selector-page-",""));u.gotoPage(T);return false})}}}ab=D.height();D.css({height:0,"padding-bottom":0});n.unbind("hover").hover(function(){D.stop().animate({height:ab,paddingBottom:10},500)},function(){D.stop().animate({height:0,paddingBottom:0},500)})}}e.extend(u,{next:function(){if(I.curr+2<I.pTotal&&!ac){ac=true;I.curr+=2;I.before.call(u);u.updatePager();u.updateCtrls();c(I.curr+1,I);am.animate({width:0},I.speedH,I.easeIn);if(I.shadows){if(e.support.opacity){U.animate({opacity:1},I.speedH,I.easeIn).animate({opacity:0},I.speedH,I.easeOut)}else{U.animate({right:I.shadowTopFwdWidth},I.speed,I.easeIn)}}ai.animate({left:I.pWidthH,width:I.pWidthH,paddingLeft:I.shadowBtmWidth},I.speedH,I.easeIn).animate({left:0,width:I.pWidth,paddingLeft:0},I.speedH);P.animate({left:I.shadowBtmWidth},I.speedH,I.easeIn).animate({left:0},I.speedH,I.easeOut,function(){u.resetPages();u.updatePager();u.updateCtrls();I.after.call(u);ac=false})}},prev:function(){if(I.curr-2>=0&&!ac){ac=true;I.curr-=2;I.before.call(u);u.updatePager();u.updateCtrls();c(I.curr+1,I);N.show();ao.animate({left:I.pWidth,width:0},I.speed,I.easing);v.animate({left:I.pWidthN},I.speed,I.easing);if(I.shadows){if(e.support.opacity){X.animate({opacity:1},I.speedH,I.easeIn).animate({opacity:0},I.speedH,I.easeOut)}else{X.animate({left:I.shadowTopBackWidth},I.speed,I.easeIn)}}aq.animate({left:I.pWidthH,width:I.pWidthH},I.speedH,I.easeIn).animate({left:I.pWidth,width:I.pWidth},I.speedH,I.easeOut);G.animate({right:I.shadowBtmWidth},I.speedH,I.easeIn).animate({right:0},I.speedH,I.easeOut,function(){u.resetPages();u.updatePager();u.updateCtrls();I.after.call(u);ac=false})}},gotoPage:function(i){if(i>I.curr&&i<I.pTotal&&i>=0&&!ac){ac=true;I.curr=i;I.before.call(u);u.updatePager();u.updateCtrls();P.html(m[I.curr]);E.html(m[I.curr+1]);if(I.pageNumbers){P.append('<div class="vb-counter">'+(I.curr+1)+"</div>");E.append('<div class="vb-counter">'+(I.curr+2)+"</div>")}am.animate({width:0},I.speedH,I.easeIn);if(I.shadows){if(e.support.opacity){U.animate({opacity:1},I.speedH,I.easeIn).animate({opacity:0},I.speedH,I.easeOut)}else{U.animate({right:I.shadowTopFwdWidth},I.speed,I.easeIn)}}ai.animate({left:I.pWidthH,width:I.pWidthH,paddingLeft:I.shadowBtmWidth},I.speedH,I.easeIn).animate({left:0,width:I.pWidth,paddingLeft:0},I.speedH);P.animate({left:I.shadowBtmWidth},I.speedH,I.easeIn).animate({left:0},I.speedH,I.easeOut,function(){u.resetPages();u.updatePager();u.updateCtrls();I.after.call(u);ac=false})}else{if(i<I.curr&&i<I.pTotal&&i>=0&&!ac){ac=true;I.curr=i;I.before.call(u);u.updatePager();u.updateCtrls();y.html(m[I.curr]);G.html(m[I.curr+1]);if(I.pageNumbers){y.append('<div class="vb-counter">'+(I.curr+1)+"</div>");G.append('<div class="vb-counter">'+(I.curr+2)+"</div>")}N.show();ao.animate({left:I.pWidth,width:0},I.speed,I.easing);v.animate({left:I.pWidthN},I.speed,I.easing);if(I.shadows){if(e.support.opacity){X.animate({opacity:1},I.speedH,I.easeIn).animate({opacity:0},I.speedH,I.easeOut)}else{X.animate({left:I.shadowTopBackWidth},I.speed,I.easeIn)}}aq.animate({left:I.pWidthH,width:I.pWidthH},I.speedH,I.easeIn).animate({left:I.pWidth,width:I.pWidth},I.speedH,I.easeOut);G.animate({right:I.shadowBtmWidth},I.speedH,I.easeIn).animate({right:0},I.speedH,I.easeOut,function(){u.resetPages();u.updatePager();u.updateCtrls();I.after.call(u);ac=false})}}},resetPages:function(){w.css({width:I.pWidth-20,height:I.pHeight-20});v.html(m[I.curr]).css({left:0,opacity:1});ao.css({left:0,width:I.pWidth,height:I.pHeight});ap.html(m[I.curr+1]);am.css({left:I.pWidth,width:I.pWidth,opacity:1,height:I.pHeight});y.html(m[I.curr-2]);N.css({left:0,width:I.pWidth,height:I.pHeight}).hide();G.html(m[I.curr-1]);aq.css({left:0,width:0,height:I.pHeight});P.html(m[I.curr+2]);ai.css({left:I.pWidth*2,width:0,height:I.pHeight});E.html(m[I.curr+3]);ah.css({left:I.pWidth,width:I.pWidth,height:I.pHeight});if(I.shadows){U.css({right:0,width:I.pWidth,height:I.pHeight});X.css({left:0,width:I.pWidth,height:I.pHeight})}if(I.pageNumbers){Z=I.curr+1;y.append('<div class="vb-counter">'+(Z-2)+"</div>");G.append('<div class="vb-counter">'+(Z-1)+"</div>");v.append('<div class="vb-counter">'+(Z)+"</div>");ap.append('<div class="vb-counter">'+(Z+1)+"</div>");P.append('<div class="vb-counter">'+(Z+2)+"</div>");E.append('<div class="vb-counter">'+(Z+3)+"</div>");if(I.direction=="RTL"){e(".vb-counter").remove();Z=Math.abs((I.pTotal-1)-I.curr);y.append('<div class="vb-counter">'+(Z+3)+"</div>");G.append('<div class="vb-counter">'+(Z+2)+"</div>");v.append('<div class="vb-counter">'+(Z+1)+"</div>");ap.append('<div class="vb-counter">'+(Z)+"</div>");P.append('<div class="vb-counter">'+(Z-1)+"</div>");E.append('<div class="vb-counter">'+(Z-2)+"</div>")}}},updateCtrls:function(){if(I.overlays||I.tabs||I.arrows){if(I.curr<I.pTotal-2){z.fadeIn("fast").css("cursor",I.cursor)}else{z.fadeOut("fast").css("cursor","default")}if(I.curr>=2&&I.curr!=0){x.fadeIn("fast").css("cursor",I.cursor)}else{x.fadeOut("fast").css("cursor","default")}}},updatePager:function(){if(I.pageSelector){e(I.menu+" .vb-selector-page .vb-current").text((I.curr+1)+" - "+(I.curr+2))}if(I.chapterSelector&&al[I.curr]!=""){e(I.menu+" .vb-selector-chapter .vb-current").text(al[I.curr])}},setupHash:function(){aa=d();if(!isNaN(aa)&&aa<=I.pTotal-1&&aa>=0&&aa!=""){if((aa%2)!=0){aa--}I.curr=aa}else{c(I.curr+1,I)}u.hash=aa},pollHash:function(){aa=d();if(!isNaN(aa)&&aa<=I.pTotal-1&&aa>=0){if(aa!=I.curr&&aa.toString()!=u.hash){if((aa%2)!=0){aa--}document.title=I.name+" - Page "+(aa+1);if(!ac){u.gotoPage(aa);u.hash=aa}}}}});if(I.next){o=e(I.next);o.click(function(i){i.preventDefault();u.next()})}if(I.prev){L=e(I.prev);L.click(function(i){i.preventDefault();u.prev()})}if(!I.overlays){B.remove()}else{if(e.browser.msie){B.css({background:"#fff",filter:"progid:DXImageTransform.Microsoft.Alpha(opacity=0) !important"})}}if(I.tabs){F.append('<div class="vb-tab vb-tab-prev vb-prev" title="Previous Page">Previous</div>');F.append('<div class="vb-tab vb-tab-next vb-next" title="Next Page">Next</div>');M=F.find(".vb-tab-next");K=F.find(".vb-tab-prev");t=F.find(".vb-tab");if(I.tabWidth){t.width(I.tabWidth)}if(I.tabHeight){t.height(I.tabHeight)}t.css({top:"-"+M.outerHeight()+"px"});F.css({marginTop:M.outerHeight()});if(I.direction=="RTL"){M.html("Previous").attr("title","Previous Page");K.html("Next").attr("title","Next Page")}}else{F.css({marginTop:0})}if(I.arrows){F.append('<div class="vb-arrow vb-arrow-prev vb-prev" title="Previous Page"><div>Previous</div></div>');F.append('<div class="vb-arrow vb-arrow-next vb-next" title="Next Page"><div>Next</div></div>');s=F.find(".vb-arrow-next");r=F.find(".vb-arrow-prev");W=F.find(".vb-arrow");if(I.direction=="RTL"){s.html("<div>Previous</div>").attr("title","Previous Page");r.html("<div>Next</div>").attr("title","Next Page")}}z=F.find(".vb-next");x=F.find(".vb-prev");z.click(function(i){i.preventDefault();u.next()});x.click(function(i){i.preventDefault();u.prev()});if(I.arrows){if(e.support.opacity){z.hover(function(){s.find("div").stop().fadeTo("fast",1)},function(){s.find("div").stop().fadeTo("fast",0)});x.hover(function(){r.find("div").stop().fadeTo("fast",1)},function(){r.find("div").stop().fadeTo("fast",0)})}else{z.hover(function(){s.find("div").show()},function(){s.find("div").hide()});x.hover(function(){r.find("div").show()},function(){r.find("div").hide()})}}if(I.keyboard){e(document).keyup(function(i){if(i.keyCode==37){u.prev()}else{if(i.keyCode==39){u.next()}}})}if(I.hash){u.setupHash();clearInterval();setInterval(function(){u.pollHash()},250)}u.gotoPage(I.curr)}function d(){var f=window.location.hash.split("/");if(f.length>1){return parseInt(f[2])-1}else{return""}}function a(f){f=f||0;var g=window.location.hash.split("/");if(g.length>0){return g[f]}else{return""}}function c(g,f){if(f.hash){window.location.hash="/page/"+g}}e.fn.viewbook.interfaces=[];e.fn.viewbook.defaults={name:null,width:600,height:400,speed:1000,direction:"LTR",startingPage:0,easing:"easeInOutQuad",easeIn:"easeInQuad",easeOut:"easeOutQuad",overlays:true,tabs:true,tabWidth:60,tabHeight:20,arrows:false,cursor:"pointer",next:null,prev:null,hash:false,keyboard:true,menu:null,pageSelector:false,chapterSelector:false,pageNumbers:true,shadows:true,shadowTopFwdWidth:166,shadowTopBackWidth:166,shadowBtmWidth:50,before:function(){},after:function(){}}})(jQuery);